#!/bin/sh

################################################################################
#      This file is part of OpenELEC - http://www.openelec.tv
#      Copyright (C) 2009-2011 Stephan Raue (stephan@openelec.tv)
#
#  This Program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2, or (at your option)
#  any later version.
#
#  This Program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with OpenELEC.tv; see the file COPYING.  If not, write to
#  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
#  http://www.gnu.org/copyleft/gpl.html
################################################################################

. config/options $1

QTLIBDIR="`find $ROOT/$BUILD -maxdepth 1 -name "qt-everywhere-opensource-src*"`/install/lib"
INSTALLDIR=$ROOT/$PKG_BUILD/install
LIBFILELIST=/tmp/mythlibraries.tmp

mkdir -p $ADDON_BUILD/$PKG_ADDON_ID/bin/sqldrivers $ADDON_BUILD/$PKG_ADDON_ID/lib $ADDON_BUILD/$PKG_ADDON_ID/share

cp -a $PKG_BUILD/install/bin/* $ADDON_BUILD/$PKG_ADDON_ID/bin
cp -a $QTLIBDIR/../plugins/sqldrivers $ADDON_BUILD/$PKG_ADDON_ID/bin
cp -a $PKG_BUILD/install/share/* $ADDON_BUILD/$PKG_ADDON_ID/share
cp -a $PKG_BUILD/install/lib/mythtv $ADDON_BUILD/$PKG_ADDON_ID/lib

### Use ldd to make a list of shared libraries required by the mythtv binaries,
### look for them in the mythtv and qt-everywhere-opensource-src package 
### directories, and copy them (dereferencing symlinks) to the addon directory.

[ -f $LIBFILELIST ] && rm $LIBFILELIST
for p in $INSTALLDIR/bin/*; do
   ldd $p 1>> $LIBFILELIST 2> /dev/null
done
mythlibs=`awk '{print $1 }' $LIBFILELIST | sort -u`
for lib in $mythlibs; do
   l="`find $INSTALLDIR/lib $QTLIBDIR -name "$lib" -printf %p -quit 2> /dev/null`"
   [ -e "$l" ] && cp --dereference "$l" "$ADDON_BUILD/$PKG_ADDON_ID/lib"
done

# For some reason $? = 1 upon exit even when i works...
exit 0
